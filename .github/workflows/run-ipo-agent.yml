name: Fetch IPOAlerts Open (15 pages) â€” hosted runner

on:
  workflow_dispatch:
  schedule:
    # every 30 minutes (adjust as needed)
    - cron: '*/30 * * * *'

jobs:
  fetch-ipos:
    runs-on: ubuntu-22.04   # or ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: python -m pip install --upgrade pip && pip install requests beautifulsoup4

      - name: Run IPO fetch script (inline)
        env:
          IPOALERTS_API_KEY: ${{ secrets.IPOALERTS_API_KEY }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}    # optional if you want Telegram
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}        # optional
        run: |
          python - <<'PY'
          import os, requests, time
          API_KEY = os.getenv("IPOALERTS_API_KEY")
          if not API_KEY:
              raise SystemExit("IPOALERTS_API_KEY not provided")
          BASE = "https://api.ipoalerts.in/ipos"
          headers = {"x-api-key": API_KEY, "Content-Type": "application/json"}
          results = []
          for page in range(1,16):
              params = {"status":"open","limit":1,"page":page}
              print(f"calling page {page} ...")
              r = requests.get(BASE, headers=headers, params=params, timeout=15)
              if r.status_code != 200:
                  print("error", r.status_code, r.text[:200])
                  time.sleep(1)
                  continue
              data = r.json()
              items = data.get("data", [])
              if items:
                  results.extend(items)
              time.sleep(1)
          print("\\nCollected:", len(results))
          for ipo in results:
              print(ipo.get("company_name"), ipo.get("symbol"), ipo.get("price_low"), ipo.get("price_high"))
          PY
